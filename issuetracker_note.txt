[ISSUETRACKER REBUILD NOTE]

- 2/13/2021, issuetracker.info registered at Route53 AWS ($12/yr, autorenewal)
- AWS EC2 smallest ubuntu leased
- Registered the domain name to EC2
    Create an elastic IP address at EC2 (allociate and associate)
    At hosted zones of Route 53, create a record for issuetracker.info that contains the elastic IP address 
- Craeted a key pair for EC2: issuetracker_keypair.pem, gmailed to me
- ssh -i issuetracker_keypair.pem ubuntu@issuetracker.info
- ufw setting at EC2
    sudo apt-get install ufw
    sudo ufw default allow outgoing
    sudo ufw default deny incoming
    sudo ufw allow ssh
    sudo ufw allow http/tcp
    sudo ufw enable
    sudo ufw status
    (sudo ufw allow 8000 <-> sudo ufw delete allow 8000)
- Modified security group for EC2 control console to include port 80 (http)
- Apache2 setting at EC2
    sudo apt-get install apache2
    sudo vim /etc/apache2/sites-available/000-default.conf
        ServerName issuetracker.info
    sudo a2ensite 000-default.conf    
    sudo service apache2 restart
    sudo service apache2 reload
    sudo systemctl reload apache2
- HTTPS setup
    sudo apt-get install snapd
    sudo snap install core; sudo snap refresh core
    sudo snap install --classic certbot
    sudo ln -s /snap/bin/certbot /usr/bin/certbot
    sudo certbot --apache
    sudo certbot renew --dry-run
    sudo apachectl configtest
    sudo ufw allow https
    sudo service apache2 restart
    * add HTTPS to security group for EC2 to include port 443 (https)    
    * CRON
        sudo crontab -e
        add:
        30 4 1 * * sudo certbot renew --quiet # every month, 4:30AM, 1st day renew
    (for django apache setting with https, refer to Corey MS's video on HTTPS)
- Change timezone: sudo timedatectl set-timezone Asia/Seoul
- Note: Linux terminal commands
    ctrl l: clear
    ctrl d: logout
    ctrl a/e: move to fron/end
    ctrl u/k: cut to/from
    ctrl y: paste
    ctrl w: cut left word
    ctrl r: reverse history search
    ctrl z/q: suspend/resume
    ctrl b/f: back/forward a character
    alt b/f: back/forward a word
    alt d: delete a word forward
    rm -rf directory
    grep -rnw '/path/to/' -e 'word_to_find' # search exact text in the given dir and sub-dirs
        -r: recursive
        -n: numbering 
        -w: exact matching
        -e: use pattern
    grep -i "search text" . # case insensitive
- Tips
    .vimrc: a few good options (also make dir ~/.vimbackup for backup files and swap files)
    .bashrc: especially history search
    sudo apt install tree
    sudo apt install dos2unix
    scp -i issuetracker_keypair.pem 'origin files' ubuntu@issuetracker.info:~/
    ssh pem key file has to have permission of 0400 from linux
    scp -r option for copying a directory
    tree -L 4 
    tree -I <folder> to exclude that specific folder
    using pipe with xargs: find -type d -name migrations | xargs ls -al
    vim case insensitive search: put "\c' such as /\c<search word>
- Vim multi buffer editing
    :buffers or :ls
    :e <file> or :badd <file> or :n <file> | tab open :tabe <file>
    :1,3bw or :bdelete 1 and :bdelete 3
    :%bw close all 
    :args <* wild card> open as indicated
    :b1 :bn :bp or :bN
    # + ctrl + ^ (normal mode)
    :bd or :bdelete close current buffer
    moving between buffers ctrl+^ and #ctrl+^ (depending on OS, ctrl+6 also works, but not always)
    multibuffer search :bufdo g/something to search/
    :ls
- Vim registers
    :reg
    "" just yanked
    "+ external
    ctrl + r (insert mode)
    ". last inserted text
    "% current file path
    ": most recently executed command
    "# last edited file name
    "= result of command, e.g., system('ls')
    just yanked word/contents are stored in buffer 0 (useful when replacing words)
- Vim search and replace
    :<range>s/f/t/x, 
    where range: none - current line, % - all lines, .,$ - to end
    x: g - all, c - confirm
    * / # whole word search forward / back
    :noh - clearing current highlights
    /"search word"\c # for case insensitive seaerch in vim
    iw: innerword -> viw highlights current word, ciw changes current word, diw deletes current word
    viwp: replace a word
- Vim movements and others
    ctrl + up / down (35 lines)
    ctrl + forward / back (70 lines)
    gg / G
    n + shift + Home / Middle / Last (n means n lines from..., H/M/L) 
    zt / zz / zb: move current line to top / center / bottom of the screen
    :!<shell command>
    :pwd current working directory
    :cd change directory
    ctrl + o / i: retrace backward / forward 
    n.: repeat last changes n times
    0 / ^ / $: 
    p / P / gp / gP
    ctrl + [: esc
    insert-mode: ctrl+w deletes a word before the cursor
    :set spell (move to misspelled [s ]s) 
    :set nospell
    f F to the char, t T to before the char
    in .vimrc define 
        command! W write
        command! Q quit
    if ctrl-s freezes the vim terminal (in linux), ctrl-q can resume it
    "0 will always have the content of the latest yank (and moves to 1, 2, ... )
    t(x): stops just before x, f(x): stops at x, w: move to next word
    daw: delete a word vs dw, db
- Vim marks 
    mc: mark current position with mark in a...Z
    'c: go to mark in current file
    'C: go to mark in any file
    '0..9: go to last exit position
    '' / '" go to position before jump, at last edit
    :marks
- Python installation (python 3.7.9 installed)
    sudo apt update
    sudo apt install software-properties-common
    sudo add-apt-repository ppa:deadsnakes/ppa
    sudo apt install python3.7
    sudo apt update
    sudo apt install python3-pip
    sudo apt install python3-django (sudo apt remove python3-django)
    sudo pip3 install virtualenv
- Linux $PATH, sudo, su, groups, and environment variables
    echo $PATH
    /etc/environment: saves initial $PATH (use less or more commands to check)
    .bashrc or .bash_profile may customize $PATH 
    path for sudo is defined in 
        sudo vim /etc/sudoers
        secure_path
    sudo su: opens a sub-terminal with root
    /etc/group: saves groups and associated users
    (e.g., more /etc/group | grep ubuntu)
    sudo only works for users in the group sudo
    find /path option filename: find files
        find . -type f -name *.txt
        find . -type d -name note*
    grep multiple strings
        grep 'stringA\|stringB'
- Bash settings in .bashrc and .bash_profile
    export PATH=$PATH:. 
        var_name=var_value, and then can access with $var_name
        export command makes local variable to global variable
        python program is located in /usr/bin (which python3.7)
    [do not use this] alias python=python3.7 
    * alias does not work with sudo, as alias only works when it is the first word of the command
    * do not use alias for python name change
    * virtualenv does not properly work under this alias 
        - virtualenv copies python3.7 when creating a virtualenv(call it as 'venv'), and names it to 'python' not 'python3.7'
        - python3.7 in venv invokes python outside of venv, which is not the intention of virtualenv
        - it is not easy to detect since alias works only when it is the first word of the command line
            which python: output the path to the python in venv
            python manage.py: due to the alias it runs manage.py with python3.7 outside of venv
            python --version: does not help as versions are the same between python in venv and python3.7 in system
    new_command() { bash_command with arguments and/or lines of commands } 
    * .bash_profile (or ~/.profile): runs once when logged in
    * .bashrc: runs for each terminal
- Shell script
    create a file with *.sh (not a must)
    sudo chmod +x <filename>
    start with #!/bin/sh (not a must)
    execute with . or source or ./<scriptfile>
    respect space in shell script
    gitacp(){
        git add .
        if [ '$1' == '' ]  
        then 
            git commit -m "wip"
        else 
            git commit -m '$1'
        fi
        git push
    }
- Virtualenv 
    * note that virtualenv uses already system-installed python (which is the first one to be found in the system)
        - python has to be pre-installed
        - pip3 is required to install virtualenv itself, but pre-installed pip3 is not reused in a newly created virtualenv (call it as 'venv')
    * you may specify a python version when creating a venv (with -p option) when there are multiple python versions installed
    * since python is copied when creating a virtualenv, command "python" has to be used, not "python3.7" (python3.7 invokes python outside of venv)
    * pip is newly installed, so the version may be different from the pre-installed pip. And, command "pip"=="pip3" in venv
    * fresh created venv does not use any pre-installed package 
    * to access previously installed packages, use sudo (e.g., sudo pip3 --version, sudo django-admin --version)
    * however, do not use sudo under venv as it refers to different versions of software/packages 
    virtualenv venv
    source venv/bin/activate 
    deactivate
    pip freeze > requirements.txt 
    (or, pip freeze --local: to only list-up locally-installed packages) 
    pip install -r requirements.txt
    (in .bashrc) venv(){ source ~/venv/bin/activate }: command "venv" to activate venv
- Django set-up
    under venv, use pip over apt (as apt may require sudo, which causes path conflict)
    pip install django (or Django)
    django-admin startproject issuetracker
    python manage.py startapp blog
- Deploying Django to AWS
    sudo apt-get update && sudo apt-get upgrade
    hostnamectl set-hostname django-server
    vim /etc/hosts 
        add (public IP address) django-server
- Django settings.py
    adjust allowed_hosts: '52.78.166.22', 'issuetracker.info'
    use config_file (i.e., config.json) to put SECRET_KEY, EMAIL_USER, EMAIL_PASS (this is app password by Google)
        be sure to follow syntax of json (e.g., double quotation and no comma at the last item)
    adjust TIME_ZONE
    add STATIC_ROOT, STATIC_URL, etc at the end of the settings.py
    adjust INTALLED_APPS to include 'crispy_forms', 'taggit', etc
- Django migrations
    Django migrations are for modifying database
    each app's migrations folder must have __init__.py file which may be an empty file
    python manage.py showmigrations, makemigratoins, migrate, insepctdb, flush ... etc 
    sometimes, you may have to delete 000*** files for clean migrations
- Django admin for issuetracker
    python manage.py createsuperuser 
    admin has to approve users registered
    It seems that you don't need to add additional permissions to the newly added users
- Apache setting for Django
    (assuming apache2 is already installed)
    sudo apt-get install libapache2-mod-wsgi-py3
    sudo cp 000-default.conf django_project.conf
    add code to django_project.conf (as recommneded in django doc):
        Alias /static ....
        <Directory ... 
        </Directory>
        WSGIScriptAlias / <path_to_wsgi.py>
        WSGIDaemonProcess <app_name> python-path=<...> python-home=<...>
        WSGIProcessGroup <app_name>
    sudo a2ensite django_project.conf
    sudo a2dissite 000-default.conf
    granting access:
        sudo chown :www-data issuetracker/db.sqlite3
        sudo chown ubuntu issuetracker/db.sqlite3
        sudo chmod 664 issuetracker/db.sqlite3
        sudo chown :www-data issuetracker
        sudo chmod 775 issuetracker
        sudo chown -R :www-data issuetracker/media
        sudo chmod -R 775 issuetracker/media
    settings.py debug=False
    sudo systemctl reload apache2
    sudo service apache2 restart
- HTTPS
    open django_project.conf in apache2
        uncomment server name issuetracker.info (if not already done)
        temporary comment out WSGI lines 
    sudo certbot --apache
        this adds codes to django_project.conf
        also creates django_project_le_ssl.conf, which has port 443 instead of 80
        remove our own codes from django_project.conf, and leave what's automatically added
        leave everything in django_project_le_ssl.conf and uncomment WSGI part
    sudo apachectl configtest 
    sudo ufw allow https 
    sudo service apache2 restart
    redirection
        <head>
            <meta http-equiv='refresh' content='0; URL=https://issuetracker.info'>
        </head>
- Django staticfiles
    during development (debug = True) static files are served from each app's static directory by the 'runserver'
    other webservers such as apache will serve static files from STATIC_ROOT, so 'collectstatic' command has to be run
    for media files which were not used with 'static' command in debug mode, MEDIA_URL and MEDIA_ROOT have to be explicitly added in urls.py (as already did)
    (media files: user uploaded static files)
- VSCode tips
    Emmet: HTML template auto completion
    Command Palette: Ctrl+Shift+P, F1
    Quick Open: Ctrl+P
    Settings: Ctrl+,
    Toggle Sidebar: Ctrl+B
    Toggle Terminal: Ctrl+`
    Keyboard Shortcuts: Ctrl+K+S
    Alt+up/down or Alt+shift+up/down: move or copy line(s)
    Ctrl+enter: start next line
    Ctrl+space: show autocompletion menus
- VSCode useful extensions
    Material theme
    Material icon theme
    Prettier - Code Formatter
     - ctrl + ,  for setting 
       change format on savePrettier:Tab Width 2
       JavaScript > Preferences: Quote Style -> single
       TypeScript > Preferences: Quote Style -> single
    bracket pair colorizer
    Indent-rainbow
    Auto rename tag
     - settings> Editor:Linked Editing (on)
    CSS PEEK
     - ctrl + 'css' -> move to definition
    HTML CSS SUPPORT
     - lets CSS autocompletion in HTML
    LIVE SERVER
     - command palette> live server: Open with Live Server
     - change default browser to Chrome
    HTML to CSS autocompletion
     - lets CSS autocompletion in CSS for tags already defined in HTML
    Kite: smarter code completion using AI
    autopep8 (pip install not vscode extension) 
     - in order not to activate pep3, put comment at the end of the line : # nopep8
- Django tips
    model query: Q objects are helpful for complex queries because they can be combined using logical operators and(&), or(|), negation(~)
    model query: __icontains looks for words case-insensitive
    in django templates, 'with' could be used with 'block' to assign variables
    Never user the built-in Django User model directly, even if the built-in Django User implementation fulfill all the requirements of your application.
    * This is also the recommendation from official doc
    * At least extend the AbstractUser model and switch the AUTH_USER_MODEL on your settings.
- Python tips
    The __init__.py file indicates that the files in a folder are part of a Python package. 
    * Without an __init__.py file, you cannot import files from another directory in a Python project.


